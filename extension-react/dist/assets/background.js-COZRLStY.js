const u="http://localhost:8000";chrome.webNavigation.onCommitted.addListener(async e=>{var i;if(e.frameId!==0)return;const t=(await chrome.storage.sync.get(["settings"])).settings||{enabled:!0,blockPhishing:!0,showWarnings:!0};if(!t.enabled)return;const s=e.url;if(s.startsWith("chrome://")||s.startsWith("chrome-extension://"))return;const o=await chrome.storage.sync.get(["whitelist"]),a=new URL(s).hostname;if(!((i=o.whitelist)!=null&&i.includes(a)))try{const n=await h(s);chrome.storage.local.set({lastScanResult:n});const{recentScans:c=[]}=await chrome.storage.local.get(["recentScans"]),g={url:s,is_phishing:n.is_phishing,threat_level:n.threat_level,confidence:n.confidence,timestamp:new Date().toISOString()};if(c.unshift(g),chrome.storage.local.set({recentScans:c.slice(0,10)}),d(n),n.is_phishing&&t.blockPhishing){const l=chrome.runtime.getURL("src/warning/warning.html")+"?url="+encodeURIComponent(s);console.log("Redirecting to warning page:",l),chrome.tabs.update(e.tabId,{url:l})}else n.is_phishing&&t.showWarnings&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"PhishBlocker Alert",message:`Potential phishing site detected: ${a}`,priority:2})}catch(n){console.error("Scan error:",n)}});async function h(e){try{const r=await fetch(`${u}/scan`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e,user_id:"extension_user"})});if(!r.ok)throw new Error("Scan failed");return await r.json()}catch(r){return console.error("API error:",r),{is_phishing:!1,confidence:0,threat_level:"Unknown",risk_factors:[]}}}async function d(e){const t=(await chrome.storage.local.get(["stats"])).stats||{scansToday:0,threatsBlocked:0,lastScan:null},s=new Date().toDateString();(t.lastScan?new Date(t.lastScan).toDateString():null)!==s&&(t.scansToday=0),t.scansToday++,e.is_phishing&&t.threatsBlocked++,t.lastScan=new Date().toISOString(),await chrome.storage.local.set({stats:t})}chrome.runtime.onMessage.addListener((e,r,t)=>{if(e.action==="scanUrl")return h(e.url).then(t),!0;e.action==="refreshProtection"&&(console.log("Protection rules refreshed"),t({success:!0})),e.action==="reportFalsePositive"&&(console.log("False positive reported:",e.url),t({success:!0}))});console.log("PhishBlocker background service worker loaded");
